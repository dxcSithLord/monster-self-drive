name: Code Quality

on:
  push:
    branches: [ main, master, claude/* ]
  pull_request:
    branches: [ main, master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  formatting:
    name: Check Code Formatting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Black
        run: pip install black

      - name: Check formatting
        run: black --check --diff . || echo "::warning::Code formatting issues found. Run 'black .' to fix."

  linting:
    name: Linting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || echo "Skipping requirements install"

      - name: Install linters
        run: |
          pip install flake8 pylint

      - name: Lint with flake8
        run: |
          # Stop on syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Full lint (non-blocking)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Lint with pylint
        run: |
          pylint *.py --exit-zero --rcfile=/dev/null || echo "::warning::Pylint found issues"

  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Lint Markdown files
        id: mdlint
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: '**/*.md'
          config: '.markdownlint.json'
        continue-on-error: true

      - name: Emit warning if markdownlint found issues
        if: ${{ steps.mdlint.conclusion == 'failure' || steps.mdlint.outcome == 'failure' }}
        run: |
          echo "::warning::markdownlint found issues. See action logs for details."
